var je=Object.defineProperty,Ge=Object.defineProperties;var Qe=Object.getOwnPropertyDescriptors;var Ce=Object.getOwnPropertySymbols;var Je=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable;var T=Math.pow,de=(k,C,I)=>C in k?je(k,C,{enumerable:!0,configurable:!0,writable:!0,value:I}):k[C]=I,M=(k,C)=>{for(var I in C||(C={}))Je.call(C,I)&&de(k,I,C[I]);if(Ce)for(var I of Ce(C))Ye.call(C,I)&&de(k,I,C[I]);return k},R=(k,C)=>Ge(k,Qe(C));var x=(k,C,I)=>de(k,typeof C!="symbol"?C+"":C,I);var Z=(k,C,I)=>new Promise((j,z)=>{var G=E=>{try{q(I.next(E))}catch(F){z(F)}},Q=E=>{try{q(I.throw(E))}catch(F){z(F)}},q=E=>E.done?j(E.value):Promise.resolve(E.value).then(G,Q);q((I=I.apply(k,C)).next())});(function(){"use strict";function k(h){const e=new Map,{workerUrl:t}=h;let{workerNumber:r=1}=h;const l=[...Array.from({length:t?r:0})].map(()=>{try{const o=new Worker(t);return o.onmessage=a,o}catch(o){return console.warn(o),null}}).filter(Boolean);r=l.length;function a(o){var c;const{id:s,data:f}=o.data;(c=e.get(s))==null||c(f),e.delete(s)}const i=function(){let o=0;return s=>l[(s!=null?s:o++)%r]}();return{call:function(){let o=0;return(s,f,c,d)=>new Promise(u=>{const g=i(d);if(!g)return u(void 0);e.set(o,u),g.postMessage({id:o++,type:s,data:f},{transfer:c})})}()}}const C="GIF",I=["87a","89a"],j=44,z=33,G=255,Q=11,q=254,E=249,F=4,Se=1,Ie=1,fe=59;function ue(h){const e=new Uint8Array(h.reduce((t,r)=>t+r.byteLength,0));return h.reduce((t,r)=>(e.set(r,t),t+r.byteLength),0),e}function ee(h,e,t){let r;if(ArrayBuffer.isView(h))r=h.buffer;else if(h instanceof ArrayBuffer)r=h;else{const l=document.createElement("canvas"),{width:a,height:i}=t||{},n=l.getContext("2d");if(!n)throw new Error("Failed to create canvas context2d");l.width=a!=null?a:"width"in h?typeof h.width=="number"?h.width:h.width.baseVal.value:0,l.height=i!=null?i:"height"in h?typeof h.height=="number"?h.height:h.height.baseVal.value:0,n.drawImage(h,0,0,l.width,l.height),r=n.getImageData(0,0,l.width,l.height).data.buffer}switch(e){case"uint8Array":return new Uint8Array(r);case"uint8ClampedArray":return new Uint8ClampedArray(r);case"dataView":return new DataView(r);default:throw new Error("Unsupported output format")}}function Be(h){const e=new Image;return e.decoding="sync",e.loading="eager",e.crossOrigin="anonymous",e.src=h,e}function ke(h){return new Promise((e,t)=>{const r=Be(h);r.onload=()=>e(r),r.onerror=t})}class Te{constructor(e){x(this,"_view");x(this,"offset",0);this._view=ee(e,"dataView")}readByte(){return this._view.getUint8(this.offset++)}readBytes(e){return Array.from({length:e}).map(()=>this.readByte())}readString(e){return String.fromCharCode(...this.readBytes(e))}readUnsigned(){return[this._view.getUint16(this.offset,!0),this.offset+=2][0]}readBits(){return this._view.getUint8(this.offset++).toString(2).padStart(8,"0").split("").map(Number)}readColorTable(e){return Array.from({length:e},()=>Array.from(this.readBytes(3)))}readSubBlock(){const e=[];for(;;){const t=this.readByte();if(t===0&&this._view.getUint8(this.offset)!==0)break;e.push(t)}return e}}function Ae(h){const e={},t=new Te(h),r=()=>({index:0,delay:100,disposal:0}),l=t.readString(3),a=t.readString(3);if(l!==C||!I.includes(a))throw new Error("This is not a 87a/89a GIF data.");e.version=a,e.width=t.readUnsigned(),e.height=t.readUnsigned();const i=t.readBits();e.globalColorTable=!!i[0],e.colorResoluTion=Number.parseInt(i.slice(1,4).join(""),2)+1,e.colorTableSorted=!!i[4];const n=Number.parseInt(i.slice(5,8).join(""),2);e.colorTableSize=T(2,n+1),e.backgroundColorIndex=t.readByte(),e.pixelAspectRatio=t.readByte(),e.globalColorTable&&(e.colorTableSize?e.colorTable=t.readColorTable(e.colorTableSize):t.readSubBlock()),e.frames=[];let o=r();const s=[],f=[];for(;;){const c=t.readByte();if(s.push(c),c===j){o.left=t.readUnsigned(),o.top=t.readUnsigned(),o.width=t.readUnsigned(),o.height=t.readUnsigned();const d=t.readBits();o.localColorTable=!!d[0],o.interlaced=!!d[1],o.colorTableSorted=!!d[2],o.reserved=Number.parseInt(d.slice(3,5).join(""),2);const u=Number.parseInt(d.slice(5,8).join(""),2);for(o.colorTableSize=T(2,u+1),o.localColorTable&&(o.colorTable=t.readColorTable(o.colorTableSize)),o.lzwMinCodeSize=t.readByte(),o.dataPositions=[];;){const g=t.readByte();if(g===0)break;const w=t.offset;o.dataPositions.push([w,g]),t.offset=w+g}e.frames.push(o),o=r(),o.index=e.frames.length;continue}if(c===z){const d=t.readByte();if(f.push(d),d===G){if(t.readByte()!==Q)continue;const u={identifier:t.readString(8),code:t.readString(3),data:[]};`${u.identifier}${u.code}`=="NETSCAPE2.0"&&t.readByte()===3&&(e.looped=!!t.readByte(),e.loopCount=t.readUnsigned()),u.data=t.readSubBlock(),o.application=u;continue}if(d===q){o.comment=t.readSubBlock().map(u=>String.fromCharCode(u)).join("");continue}if(d===E){if(t.readByte()!==F)continue;const u=t.readBits(),g={reserved:Number.parseInt(u.slice(0,3).join(""),2),disposal:Number.parseInt(u.slice(3,6).join(""),2),userInput:!!u[6],transparent:!!u[7],delayTime:t.readUnsigned(),transparentIndex:t.readByte()};t.readSubBlock(),o.graphicControl=g,o.disposal=g.disposal,o.delay=(g.delayTime||10)*10;continue}if(d===Se){if(t.readByte()!==Ie)continue;o.plainText={left:t.readUnsigned(),top:t.readUnsigned(),width:t.readUnsigned(),height:t.readUnsigned(),cellWidth:t.readByte(),cellHeight:t.readByte(),colorIndex:t.readByte(),backgroundColorIndex:t.readByte(),data:t.readSubBlock()};continue}console.warn(`Unknown extension block: 0x${d.toString(16)}`,s.slice(0,s.length-1).map(u=>`0x${u.toString(16)}`),f.slice(0,f.length-1).map(u=>`0x${u.toString(16)}`));continue}if(c===fe)break;console.warn(`Unknown block: 0x${c.toString(16)}`,s.slice(0,s.length-1).map(d=>`0x${d.toString(16)}`),f.slice(0,f.length-1).map(d=>`0x${d.toString(16)}`))}return e}function Ee(h,e){const t=Array.from({length:h.length}),r=h.length/e,l=[0,4,2,1],a=[8,8,4,2];let i=0;for(let n=0;n<4;n++)for(let o=l[n];o<r;o+=a[n])t.splice.apply(t,[o*e,e].concat(h.slice(i*e,(i+1)*e))),i++;return t}function Ue(h,e,t){const a=t;let i,n,o,s,f,c,d;const u=Array.from({length:t}),g=Array.from({length:4096}),w=Array.from({length:4096}),b=Array.from({length:4097}),B=h,S=1<<B,m=S+1;for(i=S+2,f=-1,o=B+1,n=(1<<o)-1,c=0;c<S;c++)g[c]=0,w[c]=c;let p,y,A,U,L,H;for(p=y=A=U=L=H=0,d=0;d<a;){if(U===0){if(y<o){p+=e[H]<<y,y+=8,H++;continue}if(c=p&n,p>>=o,y-=o,c>i||c===m)break;if(c===S){o=B+1,n=(1<<o)-1,i=S+2,f=-1;continue}if(f===-1){b[U++]=w[c],f=c,A=c;continue}for(s=c,c===i&&(b[U++]=A,c=f);c>S;)b[U++]=w[c],c=g[c];A=w[c]&255,b[U++]=A,i<4096&&(g[i]=f,w[i]=A,i++,!(i&n)&&i<4096&&(o++,n+=i)),f=s}U--,u[L++]=b[U],d++}for(d=L;d<a;d++)u[d]=0;return u}function ve(h,e){const t=ee(h,"uint8Array"),{gif:r=Ae(h),range:l}={},{width:a,height:i,colorTable:n,frames:o}=r,s=l?o.slice(l[0],l[1]+1):o,f=s.some(g=>g.disposal===3);let c=new Uint8ClampedArray(a*i*4),d,u=c.slice();return s.map(g=>{var ye;const{left:w,top:b,width:B,height:S,interlaced:m,localColorTable:p,colorTable:y,lzwMinCodeSize:A,dataPositions:U,graphicControl:L,delay:H,disposal:_e}=g,xe=d==null?void 0:d.disposal,Ve=b+S,{transparent:qe,transparentIndex:He}=L!=null?L:{},ae=p?y:n,Ke=qe?He:-1,Ze=ue(U.map(([N,W])=>t.subarray(N,N+W)));let le=Ue(A,Ze,B*S);if(m&&(le=Ee(le,B)),xe===3)c=u.slice();else if(xe===2){const{left:N,top:W,width:ce,height:X}=d,Y=W+X;for(let O=W;O<Y;O++){const he=O*a+N;for(let K=0;K<ce;K++){const V=(he+K)*4;c[V]=c[V+1]=c[V+2]=c[V+3]=0}}}for(let N=b;N<Ve;N++){const W=N*a+w,ce=(N-b)*B;for(let X=0;X<B;X++){const Y=le[ce+X],O=(W+X)*4;if(Y!==Ke){const[he,K,V]=(ye=ae==null?void 0:ae[Y])!=null?ye:[0,0,0];c[O]=he,c[O+1]=K,c[O+2]=V,c[O+3]=255}}}return f&&_e!==1&&_e!==3&&(u=c.slice()),d=g,{width:a,height:i,delay:H,data:c.slice()}})}const Ne=typeof window<"u",_=65535,P=_*_,Me=511,te=[0,20,40,60,80,99,119,139,159,179,199,219,241,264,288,313,340,367,396,427,458,491,526,562,599,637,677,718,761,805,851,898,947,997,1048,1101,1156,1212,1270,1330,1391,1453,1517,1583,1651,1720,1790,1863,1937,2013,2090,2170,2250,2333,2418,2504,2592,2681,2773,2866,2961,3058,3157,3258,3360,3464,3570,3678,3788,3900,4014,4129,4247,4366,4488,4611,4736,4864,4993,5124,5257,5392,5530,5669,5810,5953,6099,6246,6395,6547,6700,6856,7014,7174,7335,7500,7666,7834,8004,8177,8352,8528,8708,8889,9072,9258,9445,9635,9828,10022,10219,10417,10619,10822,11028,11235,11446,11658,11873,12090,12309,12530,12754,12980,13209,13440,13673,13909,14146,14387,14629,14874,15122,15371,15623,15878,16135,16394,16656,16920,17187,17456,17727,18001,18277,18556,18837,19121,19407,19696,19987,20281,20577,20876,21177,21481,21787,22096,22407,22721,23038,23357,23678,24002,24329,24658,24990,25325,25662,26001,26344,26688,27036,27386,27739,28094,28452,28813,29176,29542,29911,30282,30656,31033,31412,31794,32179,32567,32957,33350,33745,34143,34544,34948,35355,35764,36176,36591,37008,37429,37852,38278,38706,39138,39572,40009,40449,40891,41337,41785,42236,42690,43147,43606,44069,44534,45002,45473,45947,46423,46903,47385,47871,48359,48850,49344,49841,50341,50844,51349,51858,52369,52884,53401,53921,54445,54971,55500,56032,56567,57105,57646,58190,58737,59287,59840,60396,60955,61517,62082,62650,63221,63795,64372,64952,65535],ge=[0,6,13,18,22,25,28,31,34,36,38,40,42,44,46,48,50,51,53,54,56,57,59,60,61,62,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,86,87,88,89,90,91,91,92,93,94,95,95,96,97,98,98,99,100,101,101,102,103,103,104,105,106,106,107,108,108,109,110,110,111,111,112,113,113,114,115,115,116,116,117,118,118,119,119,120,121,121,122,122,123,123,124,125,125,126,126,127,127,128,128,129,129,130,130,131,132,132,133,133,134,134,135,135,136,136,137,137,138,138,139,139,140,140,140,141,141,142,142,143,143,144,144,145,145,146,146,147,147,147,148,148,149,149,150,150,151,151,151,152,152,153,153,154,154,154,155,155,156,156,156,157,157,158,158,159,159,159,160,160,161,161,161,162,162,163,163,163,164,164,165,165,165,166,166,166,167,167,168,168,168,169,169,169,170,170,171,171,171,172,172,172,173,173,174,174,174,175,175,175,176,176,176,177,177,177,178,178,179,179,179,180,180,180,181,181,181,182,182,182,183,183,183,184,184,184,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,191,191,191,192,192,192,193,193,193,193,194,194,194,195,195,195,196,196,196,197,197,197,198,198,198,198,199,199,199,200,200,200,201,201,201,201,202,202,202,203,203,203,204,204,204,204,205,205,205,206,206,206,206,207,207,207,208,208,208,208,209,209,209,210,210,210,210,211,211,211,212,212,212,212,213,213,213,214,214,214,214,215,215,215,215,216,216,216,217,217,217,217,218,218,218,218,219,219,219,220,220,220,220,221,221,221,221,222,222,222,222,223,223,223,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,227,228,228,228,228,229,229,229,229,230,230,230,230,231,231,231,231,232,232,232,232,233,233,233,233,234,234,234,234,235,235,235,235,236,236,236,236,237,237,237,237,238,238,238,238,239,239,239,239,239,240,240,240,240,241,241,241,241,242,242,242,242,243,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,249,250,250,250,250,251,251,251,251,251,252,252,252,252,253,253,253,253,253,254,254,254,254,255,255,255];function re(h){let e;if(h<=0)return 0;if(h>=_)return _;e=h*(h*(h+-144107)/_+132114)/_+14379;for(let t=0;t<2;t++){const r=e*e*e,l=h+(2*r+P/2)/P;e=(e*(2*h+(r+P/2)/P)+l/2)/l}return e}function v(h,e){return(h^e)<0?(h-e/2)/e:(h+e/2)/e}function we(h,e,t,r,l=!0,a=[255,255,255]){if(!l){r/=255;const i=1-r;h=h*r+i*a[0]&255,e=e*r+i*a[1]&255,t=t*r+i*a[2]&255}return{r:h,g:e,b:t}}function ne(h,e,t){return h<<16|e<<8|t}function be(h,e,t){h=te[h],e=te[e],t=te[t];const r=(27015*h+35149*e+3372*t+_/2)/_,l=(13887*h+44610*e+7038*t+_/2)/_,a=(5787*h+18462*e+41286*t+_/2)/_,i=re(r),n=re(l),o=re(a);return{l:v(13792*i+52010*n-267*o,_),a:v(129628*i-159158*n+29530*o,_),b:v(1698*i+51299*n-52997*o,_)}}function ie(h){if(h<=0)return 0;if(h>=_)return 255;{const e=h*Me,t=~~(e/_),r=e%_,l=ge[t],a=ge[t+1];return(r*(a-l)+_/2)/_+l}}function Oe(h){const e=h.l+v(25974*h.a,_)+v(14143*h.b,_),t=h.l+v(-6918*h.a,_)+v(-4185*h.b,_),r=h.l+v(-5864*h.a,_)+v(-84638*h.b,_),l=T(e,3)/P,a=T(t,3)/P,i=T(r,3)/P,n=~~ie((267169*l+-216771*a+15137*i+_/2)/_),o=~~ie((-83127*l+171030*a+-22368*i+_/2)/_),s=~~ie((-275*l+-46099*a+111909*i+_/2)/_);return{r:n,g:o,b:s}}function Re(h){return new Promise(e=>{const t=new Image;t.decoding="sync",t.loading="eager",t.crossOrigin="anonymous",t.onload=()=>e(t),t.onerror=()=>e(t),t.src=h})}class J{constructor(){this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>Z(this,null,function*(){var r,l,a,i;let t;switch(typeof e){case"string":{const n=yield Re(e),o=J.ctx2d,s=o.canvas;o.clearRect(0,0,s.width,s.height),s.width=n.width,s.height=n.height,o.drawImage(n,0,0,s.width,s.height),t=o.getImageData(0,0,s.width,s.height).data;break}default:if(ArrayBuffer.isView(e))t=new Uint8ClampedArray(e.buffer);else if(e instanceof ArrayBuffer)t=new Uint8ClampedArray(e);else if(Array.isArray(e))if(Array.isArray(e[0])){const n=[];for(let o=e.length,s=0;s<o;s++)n.push((r=e[s][0])!=null?r:0,(l=e[s][1])!=null?l:0,(a=e[s][2])!=null?a:0,(i=e[s][3])!=null?i:255);t=new Uint8ClampedArray(n)}else t=new Uint8ClampedArray(e);else{const n=J.ctx2d,o=n.canvas;n.clearRect(0,0,o.width,o.height),o.width=typeof e.width=="number"?e.width:e.width.baseVal.value,o.height=typeof e.height=="number"?e.height:e.height.baseVal.value,n.drawImage(e,0,0,o.width,o.height),t=n.getImageData(0,0,o.width,o.height).data}break}this._rsControler.enqueue(t)}),close:()=>{this._rsControler.close()}})}static get ctx2d(){if(!this._ctx2d){if(!Ne)throw new Error("Failed to get ImageToPixels.ctx2d, not in browser.");const e=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});if(!e)throw new Error("Failed to get ImageToPixels.ctx2d, getContext('2d') return null.");this._ctx2d=e}return this._ctx2d}}class oe{constructor(e){this.maxColors=e,this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>{this._rsControler.enqueue(this._boxesToQuantizedColors(this._colorsToBoxes(t)))},close:()=>{this._rsControler.close()}})}static createSorter(e){const t=e[0],r=e[1],l=e[2];return(a,i)=>a.lab[t]-i.lab[t]||a.lab[r]-i.lab[r]||a.lab[l]-i.lab[l]}_colorsToBoxes(e){let t={start:0,end:e.length-1,sorted:null,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};const r=[t];let l=1;const a=(s,f,c)=>s>=f?f>=c?"lab":s>=c?"lba":"bla":s>=c?"alb":f>=c?"abl":"bal",i=s=>{const{start:f,end:c}=s;s.count=c-f+1,s.weight=0;const d={l:0,a:0,b:0};for(let g=f;g<=c;g++){const w=e[g];d.l+=w.lab.l*w.count,d.a+=w.lab.a*w.count,d.b+=w.lab.b*w.count,s.weight+=w.count}s.avg.l=d.l/s.weight,s.avg.a=d.a/s.weight,s.avg.b=d.b/s.weight;const u={l:0,a:0,b:0};for(let g=f;g<=c;g++){const w=e[g];u.l+=T(w.lab.l-s.avg.l,2)*w.count,u.a+=T(w.lab.a-s.avg.a,2)*w.count,u.b+=T(w.lab.b-s.avg.b,2)*w.count}s.sort=a(u.l,u.a,u.b),s.score=Math.max(u.l,u.a,u.b)},n=(s,f)=>{const c={start:f+1,end:s.end,sorted:s.sorted,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};i(c),s.end-=c.count,i(s),r.push(c),l++},o=()=>{let s=-1,f=-1;if(l===this.maxColors)return-1;for(let c=0;c<l;c++){const d=r[c];d.count>=2&&d.score>f&&(s=c,f=d.score)}return s};for(i(t);t&&t.count>1;){const{start:s,end:f,sort:c,sorted:d}=t;if(c!==d){const B=e.slice(s,f+1).sort(oe.createSorter(c));for(let S=B.length,m=0;m<S;m++)e[s+m]=B[m];t.sorted=c}const u=t.weight+1>>1;let g=s,w=0;for(;g<f-1&&(w+=e[g].count,!(w>u));g++);n(t,g);const b=o();t=b>=0?r[b]:null}return r}_boxesToQuantizedColors(e){const t=e.reduce((r,l)=>r+l.weight,0);return e.map(r=>{const{r:l,g:a,b:i}=Oe(r.avg);return{rgbInt:ne(l,a,i),rgb:{r:l,g:a,b:i},hex:`#${l.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`,lab:r.avg,count:r.weight,percentage:r.weight/t}}).sort((r,l)=>r.rgbInt-l.rgbInt)}}class Pe{constructor(e,t,r){this.statsMode=e,this.premultipliedAlpha=t,this.tint=r,this._colors=[],this._cache=new Map,this.readable=new ReadableStream({start:l=>this._rsControler=l}),this.writable=new WritableStream({write:l=>{for(let a=l.length,i=0;i<a;i+=4){let n=l[i],o=l[i+1],s=l[i+2];const f=l[i+3];if(this.statsMode==="diff"&&this._previousPixels&&n===this._previousPixels[i]&&o===this._previousPixels[i+1]&&s===this._previousPixels[i+2]&&f===this._previousPixels[i+3])continue;({r:n,g:o,b:s}=we(n,o,s,f,this.premultipliedAlpha,this.tint));const c=ne(n,o,s),d={rgbInt:c,lab:be(n,o,s),count:1},u=c%32768;let g=this._cache.get(u);g||this._cache.set(u,g=new Map);let w=g.get(c);if(w!==void 0){this._colors[w].count++;continue}w=this._colors.push(d)-1,g.set(c,w)}this.statsMode==="diff"&&(this._previousPixels=l)},close:()=>{this._rsControler.enqueue(this._colors.slice()),this._rsControler.close(),this._colors.length=0,this._cache.clear(),this._previousPixels=void 0}})}}class pe{constructor(e=[],t=!1,r=[255,255,255]){this._premultipliedAlpha=t,this._tint=r,this._cache=new Map,this._colorMap=[],e.length&&this.setup(e)}setup(e){e=e.sort((i,n)=>i.rgbInt-n.rgbInt),this._cache.clear();const t=[],r=new Map;for(let i=-1,n=e.length,o=0;o<n;o++){const{rgbInt:s}=e[o];if(s===i){r.set(o,!0);continue}i=s}a({min:[-65535,-65535,-65535],max:[65535,65535,65535]}),this._colorMap=t;function l(i){const n={min:[65535,65535,65535],max:[-65535,-65535,-65535]},o=[];for(let g=e.length,w=0;w<g;w++){const{lab:b}=e[w];r.has(w)||b.l<i.min[0]||b.a<i.min[1]||b.b<i.min[2]||b.l>i.max[0]||b.a>i.max[1]||b.b>i.max[2]||(b.l<n.min[0]&&(n.min[0]=b.l),b.a<n.min[1]&&(n.min[1]=b.a),b.b<n.min[2]&&(n.min[2]=b.b),b.l>n.max[0]&&(n.max[0]=b.l),b.a>n.max[1]&&(n.max[1]=b.a),b.b>n.max[2]&&(n.max[2]=b.b),o.push({lab:b,index:w}))}let s="l",f=0;if(!o.length)return{index:-1,longest:s,longestIndex:f};const c=n.max[0]-n.min[0],d=n.max[1]-n.min[1],u=n.max[2]-n.min[2];return u>=c&&u>=d&&(s="b",f=2),d>=c&&d>=u&&(s="a",f=1),c>=d&&c>=u&&(s="l",f=0),{index:o.sort((g,w)=>g.lab[s]-w.lab[s])[o.length>>1].index,longest:s,longestIndex:f}}function a(i){const{index:n,longest:o,longestIndex:s}=l(i);if(n<0)return-1;r.set(n,!0);const{lab:f}=e[n],c={left:0,right:0,longest:o,lab:f,index:n},d=t.push(c)-1,u={max:[...i.max],min:[...i.min]},g={max:[...i.max],min:[...i.min]};u.max[s]=f[o],g.min[s]=Math.min(f[o]+1,65535);const w=a(u);let b=-1;return g.min[s]<=g.max[s]&&(b=a(g)),c.left=w,c.right=b,d}}_colormapNearestNode(e,t,r){const{left:l,right:a,longest:i,lab:n,index:o}=this._colorMap[e],s=Math.min(T(t.l-n.l,2)+T(t.a-n.a,2)+T(t.b-n.b,2),4294967294);s<r.dist&&(r.index=o,r.dist=s);let f,c;if(l!==-1||a!==-1){const d=t[i]-n[i];d<=0?(f=l,c=a):(f=a,c=l),f!==-1&&this._colormapNearestNode(f,t,r),c!==-1&&T(d,2)<r.dist&&this._colormapNearestNode(c,t,r)}}findNearestIndex(e,t,r,l=255){({r:e,g:t,b:r}=we(e,t,r,l,this._premultipliedAlpha,this._tint));const a=ne(e,t,r),i=a%32768;let n=this._cache.get(i);n||this._cache.set(i,n=new Map);let o=n.get(a);if(o!==void 0)return o;const s={dist:Number.MAX_SAFE_INTEGER,index:-1};return this._colormapNearestNode(0,be(e,t,r),s),o=s.index,n.set(a,o),o}}class $e{constructor(e={}){this.colors=[],this.config=this._resolveOptions(e),this._stream=this._createStream()}_resolveOptions(e){const{maxColors:t=256,statsMode:r="full",algorithm:l="median-cut",premultipliedAlpha:a=!1,tint:i=[255,255,255],samples:n=[]}=e;return{maxColors:t,statsMode:r,algorithm:l,premultipliedAlpha:a,tint:i,samples:n}}_createStream(){let e;switch(this.config.algorithm){case"median-cut":default:e=new oe(this.config.maxColors);break}return new ReadableStream({start:t=>{this._streamControler=t,this.config.samples.forEach(r=>t.enqueue(r))}}).pipeThrough(new J).pipeThrough(new Pe(this.config.statsMode,this.config.premultipliedAlpha,this.config.tint)).pipeThrough(e)}addSample(e){this._streamControler.enqueue(e)}generate(){return new Promise(e=>{this._streamControler.close(),this._stream.pipeTo(new WritableStream({write:t=>{this.colors=t,this.finder=new pe(t,this.config.premultipliedAlpha,this.config.tint),this._stream=this._createStream(),e(t)}}))})}match(e){var t;let r;if(typeof e=="number")r=[e>>24&255,e>>16&255,e>>8&255,e&255];else if(typeof e=="string"){const i=e.replace(/^#/,"");r=[`${i[0]}${i[1]}`,`${i[2]}${i[3]}`,`${i[4]}${i[5]}`].map(n=>parseInt(n,16))}else if(Array.isArray(e))r=e;else throw new TypeError("Unsupported color format");const l=(t=this.finder)==null?void 0:t.findNearestIndex(r[0],r[1],r[2],r[3]);if(l===void 0||l<0)return;const a=this.colors[l];if(a)return{color:a,index:l}}toColors(){return this.colors.slice()}toHexColors(){return this.colors.map(e=>e.hex)}toRgbColors(){return this.colors.map(e=>e.rgb)}toRgbIntColors(){return this.colors.map(e=>e.rgbInt)}toLabColors(){return this.colors.map(e=>e.lab)}toUint8Array(e=this.colors.length*4){var a;var t;let r;const l=new Uint8ClampedArray(e);for(let i=0;i<e;i++){const n=i*4,o=(a=(t=this.colors[i])==null?void 0:t.rgb)!=null?a:r;o&&(l[n]=o.r,l[n+1]=o.g,l[n+2]=o.b,l[n+3]=255,r=o)}return l}clear(){this.colors.length=0,this._stream=this._createStream()}}const D=class D{constructor(e=!0){this.isDebug=e}time(e){this.isDebug&&console.time(`${D.prefix} ${e}`)}timeEnd(e){this.isDebug&&console.timeEnd(`${D.prefix} ${e}`)}debug(...e){this.isDebug&&console.debug(D.prefix,...e)}warn(...e){this.isDebug&&console.warn(D.prefix,...e)}};x(D,"prefix","[modern-gif]");let se=D;class De{constructor(e){x(this,"_rsControler");x(this,"_frames",[]);x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{this._frames.push(e)},close:()=>{const e=this._config.backgroundColorIndex;let t;this._frames.forEach((r,l)=>{var B,S;const{width:a=1,height:i=1,data:n}=r,o=r.transparent||((S=(B=this._frames[l+1])==null?void 0:B.transparent)!=null?S:!0);let s=0,f=0,c=a-1,d=i-1,u;if(o){for(;f<d;){let m=!0;for(let p=0;p<a;p++)if(n[a*f+p]!==e){m=!1;break}if(!m)break;f++}for(;d>f;){let m=!0;for(let p=0;p<a;p++)if(n[a*d+p]!==e){m=!1;break}if(!m)break;d--}for(;s<c;){let m=!0;for(let p=f;p<d;p++)if(n[a*p+s]!==e){m=!1;break}if(!m)break;s++}for(;c>s;){let m=!0;for(let p=f;p<d;p++)if(n[a*p+c]!==e){m=!1;break}if(!m)break;c--}}else{if(t){for(;f<d;){let m=!0;for(let p=0;p<a;p++){const y=a*f+p;if(n[y]!==t[y]){m=!1;break}}if(!m)break;f++}for(;d>f;){let m=!0;for(let p=0;p<a;p++){const y=a*d+p;if(n[y]!==t[y]){m=!1;break}}if(!m)break;d--}if(f===d)s=c;else{for(;s<c;){let m=!0;for(let p=f;p<=d;p++){const y=p*a+s;if(n[y]!==t[y]){m=!1;break}}if(!m)break;s++}for(;c>s;){let m=!0;for(let p=f;p<=d;p++){const y=p*a+c;if(n[y]!==t[y]){m=!1;break}}if(!m)break;c--}}}u=t,t=n}const g=c+1-s,w=d+1-f,b=new Uint8ClampedArray(g*w);for(let m=0;m<w;m++)for(let p=0;p<g;p++){const y=m*g+p,A=(f+m)*a+(s+p);if(!o&&u&&n[A]===u[A]){b[y]=e;continue}b[y]=n[A]}this._rsControler.enqueue(R(M({},r),{left:s,top:f,width:g,height:w,disposal:o?2:1,data:b,graphicControl:R(M({},r.graphicControl),{transparent:!0,transparentIndex:e})}))}),this._rsControler.close()}}));this._config=e}}class me{constructor(e=4096){x(this,"_chunks");x(this,"_chunkIndex",0);x(this,"_chunkOffset",0);this._chunkByteLength=e,this._chunks=[this._createChunk()]}get cursor(){return[this._chunkIndex,this._chunkOffset]}_createChunk(){return new DataView(new ArrayBuffer(this._chunkByteLength))}writeByte(e,t){t?this._chunks[t[0]].setUint8(t[1],e):(this._chunkOffset>=this._chunkByteLength&&(this._chunks[++this._chunkIndex]=this._createChunk(),this._chunkOffset=0),this._chunks[this._chunkIndex].setUint8(this._chunkOffset++,e))}writeBytes(e){e.forEach(t=>this.writeByte(t))}writeString(e){e.split("").forEach(t=>{this.writeByte(t.charCodeAt(0))})}writeUnsigned(e){this.writeBytes([e&255,e>>8&255])}calculateDistance(e){return this._chunkIndex*this._chunkByteLength+this._chunkOffset-(e[0]*this._chunkByteLength+e[1])}toUint8Array(){this._chunks[this._chunkIndex]=new DataView(this._chunks[this._chunkIndex].buffer.slice(0,this._chunkOffset));const e=new Uint8Array(this._chunks.reduce((r,l)=>r+l.byteLength,0));let t=0;return this._chunks.forEach(r=>{e.set(new Uint8Array(r.buffer),t),t+=r.byteLength}),this._chunks=[this._createChunk()],this._chunkIndex=0,this._chunkOffset=0,e}}class Le{constructor(e){x(this,"_rsControler");x(this,"_frames",[]);x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{this._frames.push(e)},close:()=>{const e=this._encodeHeader(),t=ue(this._frames),r=new Uint8Array(e.length+t.byteLength+1);r.set(e),r.set(t,e.byteLength),r[r.length-1]=fe,this._rsControler.enqueue(r),this._rsControler.close(),this._frames.length=0}}));this._config=e}_encodeHeader(){var l,a,i;const e=M({version:"89a",looped:!0,loopCount:0,pixelAspectRatio:0},this._config);if(e.width<=0||e.width>65535)throw new Error("Width invalid.");if(e.height<=0||e.height>65535)throw new Error("Height invalid.");let t=0;if((l=e.colorTable)!=null&&l.length){let n=e.colorTable.length;if(n<2||n>256||n&n-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;n>>=1;)++t;if(n=1<<t,e.colorTableSize=--t,e.backgroundColorIndex>=n)throw new Error("Background index out of range.");if(e.backgroundColorIndex===0)throw new Error("Background index explicitly passed as 0.")}const r=new me;return r.writeString(C),r.writeString(e.version),r.writeUnsigned(e.width),r.writeUnsigned(e.height),r.writeByte(Number.parseInt(`${e.colorTableSize?1:0}1110${e.colorTableSize.toString(2).padStart(3,"0")}`,2)),r.writeByte(e.backgroundColorIndex),r.writeByte(e.pixelAspectRatio),r.writeBytes((i=(a=e.colorTable)==null?void 0:a.flat())!=null?i:[]),e.looped&&(r.writeByte(z),r.writeByte(G),r.writeByte(Q),r.writeString("NETSCAPE2.0"),r.writeByte(3),r.writeByte(1),r.writeUnsigned(e.loopCount),r.writeByte(0)),r.toUint8Array()}}function ze(h,e,t){t.writeByte(h);let r=t.cursor;t.writeByte(0);const l=1<<h,a=l-1,i=l+1;let n=i+1,o=h+1,s=0,f=0;function c(S){for(;s>=S;)t.writeByte(f&255),f>>=8,s-=8,t.calculateDistance(r)===256&&(t.writeByte(255,r),r=t.cursor,t.writeByte(0))}function d(S){f|=S<<s,s+=o,c(8)}let u=e[0]&a,g={},w,b,B;d(l);for(let S=e.length,m=1;m<S;++m)if(B=e[m]&a,w=u<<8|B,b=g[w],b===void 0){for(f|=u<<s,s+=o;s>=8;)t.writeByte(f&255),f>>=8,s-=8,t.calculateDistance(r)===256&&(t.writeByte(255,r),r=t.cursor,t.writeByte(0));n===4096?(d(l),n=i+1,o=h+1,g={}):(n>=1<<o&&++o,g[w]=n++),u=B}else u=b;d(u),d(i),c(1),t.calculateDistance(r)===1?t.writeByte(0,r):(t.writeByte(t.calculateDistance(r)-1,r),t.writeByte(0))}class Fe{constructor(e){x(this,"_rsControler");x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{var g,w,b;const t=new me,{left:r=0,top:l=0,width:a=0,height:i=0,delay:n=100,colorTable:o}=e;let{disposal:s=0}=e;const f=(g=e.graphicControl)==null?void 0:g.transparent;let c=(b=(w=e.graphicControl)==null?void 0:w.transparentIndex)!=null?b:255;if(r<0||r>65535)throw new Error("Left invalid.");if(l<0||l>65535)throw new Error("Top invalid.");if(a<=0||a>65535)throw new Error("Width invalid.");if(i<=0||i>65535)throw new Error("Height invalid.");let d=8,u=o?o.length:0;if(u){if(u<2||u>256||u&u-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;u>>=1;)++d}t.writeByte(z),t.writeByte(E),t.writeByte(F),f?s||(s=2):c=0,t.writeByte(Number.parseInt(`000${Number(s&7).toString(2).padStart(3,"0")}0${f?1:0}`,2)),t.writeUnsigned(n/10),t.writeByte(c),t.writeByte(0),t.writeByte(j),t.writeUnsigned(r),t.writeUnsigned(l),t.writeUnsigned(a),t.writeUnsigned(i),o!=null&&o.length?(t.writeByte(Number.parseInt(`10000${(d-1).toString(2).padStart(3,"0")}`,2)),t.writeBytes(o.flat())):t.writeByte(0),ze(d,e.data,t),this._rsControler.enqueue(t.toUint8Array())},close:()=>this._rsControler.close()}));this._config=e}}class We{constructor(e,t){x(this,"_rsControler");x(this,"_finder");x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{const t=this._config.backgroundColorIndex,r=e.data;let l=!1;const a=new Uint8ClampedArray(r.length/4);for(let i=r.length,n=0;n<i;n+=4)r[n+3]===0?(a[n/4]=t,l=!0):a[n/4]=this._finder.findNearestIndex(r[n],r[n+1],r[n+2],r[n+3]);this._rsControler.enqueue(R(M({},e),{data:a,transparent:l}))},close:()=>{this._rsControler.close()}}));this._config=e,this._finder=new pe(t,e.premultipliedAlpha,e.tint)}}class Xe{constructor(e){x(this,"_logger");x(this,"_palette");x(this,"_config");x(this,"_encodingFrames",[]);x(this,"_encodeUUID",0);x(this,"_worker");var t;this._logger=new se(!!e.debug),this._config=this._resolveOptions(e),this._palette=new $e({maxColors:this._config.maxColors,premultipliedAlpha:this._config.premultipliedAlpha,tint:this._config.tint}),this._config.workerUrl?(this._worker=k({workerUrl:this._config.workerUrl}),this._worker.call("encoder:init",e)):(t=this._config.frames)==null||t.forEach(r=>this.encode(r))}_resolveOptions(e){["width","height"].forEach(n=>{typeof e[n]!="undefined"&&Math.floor(e[n])!==e[n]&&(console.warn(`${n} cannot be a floating point number`),e[n]=Math.floor(e[n]))});const{colorTableSize:t=256,backgroundColorIndex:r=t-1,maxColors:l=t-1,premultipliedAlpha:a=!1,tint:i=[255,255,255]}=e;return R(M({},e),{colorTableSize:t,backgroundColorIndex:r,maxColors:l,premultipliedAlpha:a,tint:i})}encode(e){return Z(this,null,function*(){if(this._worker){let i;return ArrayBuffer.isView(e.data)?i=[e.data.buffer]:e.data instanceof ArrayBuffer&&(i=[e.data]),this._worker.call("encoder:encode",e,i)}const t=this._encodeUUID;this._encodeUUID++;const{width:r=this._config.width,height:l=this._config.height}=e;let{data:a}=e;try{this._logger.time(`palette:sample-${t}`),a=typeof a=="string"?yield ke(a):a,a=ee(a,"uint8ClampedArray",{width:r,height:l}),this._encodingFrames.push(R(M({},e),{width:r,height:l,data:a})),this._palette.addSample(a)}finally{this._logger.timeEnd(`palette:sample-${t}`)}})}flush(e){return Z(this,null,function*(){if(this._worker)return this._worker.call("encoder:flush",e);this._logger.time("palette:generate");const t=yield this._palette.generate();this._logger.timeEnd("palette:generate");const r=t.map(a=>[a.rgb.r,a.rgb.g,a.rgb.b]);for(;r.length<this._config.colorTableSize;)r.push([0,0,0]);this._logger.debug("palette:maxColors",this._config.maxColors),this._logger.isDebug&&console.debug(t.map(()=>"%c ").join(""),...t.map(a=>`margin: 1px; background: ${a.hex}`)),this._logger.time("encode");const l=yield new Promise(a=>{new ReadableStream({start:i=>{this._encodingFrames.forEach(n=>{i.enqueue(n)}),i.close()}}).pipeThrough(new We(this._config,t)).pipeThrough(new De(this._config)).pipeThrough(new Fe(this._config)).pipeThrough(new Le(R(M({},this._config),{colorTable:r}))).pipeTo(new WritableStream({write:i=>a(i)}))});switch(this._logger.timeEnd("encode"),this._encodingFrames=[],this._encodeUUID=0,e){case"blob":return new Blob([l.buffer],{type:"image/gif"});case"arrayBuffer":default:return l.buffer}})}}let $;self.onmessage=h=>Z(this,null,function*(){const{id:e,type:t,data:r}=h.data;switch(t){case"encoder:init":return $=new Xe(R(M({},r),{workerUrl:void 0})),self.postMessage({id:e,type:t,data:!0});case"encoder:encode":return self.postMessage({id:e,type:t,data:yield $==null?void 0:$.encode(r)});case"encoder:flush":return self.postMessage({id:e,type:t,data:yield $==null?void 0:$.flush(r)});case"frames:decode":{const l=ve(r);return self.postMessage({id:e,type:t,data:l},l.map(a=>a.data.buffer))}}})})();
