(function(C,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(C=typeof globalThis<"u"?globalThis:C||self,E(C.modernGif={}))})(this,function(C){"use strict";var Re=Object.defineProperty;var Me=(C,E,R)=>E in C?Re(C,E,{enumerable:!0,configurable:!0,writable:!0,value:R}):C[E]=R;var x=(C,E,R)=>Me(C,typeof E!="symbol"?E+"":E,R);const E="GIF",R=["87a","89a"];function K(h){const e=new Uint8Array(h.reduce((t,r)=>t+r.byteLength,0));return h.reduce((t,r)=>(e.set(r,t),t+r.byteLength),0),e}function F(h,e,t){let r;if(ArrayBuffer.isView(h))r=h.buffer;else if(h instanceof ArrayBuffer)r=h;else{const s=document.createElement("canvas"),{width:i,height:n}=t||{},o=s.getContext("2d");if(!o)throw new Error("Failed to create canvas context2d");s.width=i??("width"in h?typeof h.width=="number"?h.width:h.width.baseVal.value:0),s.height=n??("height"in h?typeof h.height=="number"?h.height:h.height.baseVal.value:0),o.drawImage(h,0,0,s.width,s.height),r=o.getImageData(0,0,s.width,s.height).data.buffer}switch(e){case"uint8Array":return new Uint8Array(r);case"uint8ClampedArray":return new Uint8ClampedArray(r);case"dataView":return new DataView(r);default:throw new Error("Unsupported output format")}}function we(h){const e=new Image;return e.decoding="sync",e.loading="eager",e.crossOrigin="anonymous",e.src=h,e}function be(h){return new Promise((e,t)=>{const r=we(h);r.onload=()=>e(r),r.onerror=t})}class pe{constructor(e){x(this,"_view");x(this,"offset",0);this._view=F(e,"dataView")}readByte(){return this._view.getUint8(this.offset++)}readBytes(e){return Array.from({length:e}).map(()=>this.readByte())}readString(e){return String.fromCharCode(...this.readBytes(e))}readUnsigned(){return[this._view.getUint16(this.offset,!0),this.offset+=2][0]}readBits(){return this._view.getUint8(this.offset++).toString(2).padStart(8,"0").split("").map(Number)}readColorTable(e){return Array.from({length:e},()=>Array.from(this.readBytes(3)))}readSubBlock(){const e=[];for(;;){const t=this.readByte();if(t===0&&this._view.getUint8(this.offset)!==0)break;e.push(t)}return e}}function ie(h){const e={},t=new pe(h),r=()=>({index:0,delay:100,disposal:0}),s=t.readString(3),i=t.readString(3);if(s!==E||!R.includes(i))throw new Error("This is not a 87a/89a GIF data.");e.version=i,e.width=t.readUnsigned(),e.height=t.readUnsigned();const n=t.readBits();e.globalColorTable=!!n[0],e.colorResoluTion=Number.parseInt(n.slice(1,4).join(""),2)+1,e.colorTableSorted=!!n[4];const o=Number.parseInt(n.slice(5,8).join(""),2);e.colorTableSize=2**(o+1),e.backgroundColorIndex=t.readByte(),e.pixelAspectRatio=t.readByte(),e.globalColorTable&&(e.colorTableSize?e.colorTable=t.readColorTable(e.colorTableSize):t.readSubBlock()),e.frames=[];let a=r();const l=[],f=[];for(;;){const c=t.readByte();if(l.push(c),c===44){a.left=t.readUnsigned(),a.top=t.readUnsigned(),a.width=t.readUnsigned(),a.height=t.readUnsigned();const d=t.readBits();a.localColorTable=!!d[0],a.interlaced=!!d[1],a.colorTableSorted=!!d[2],a.reserved=Number.parseInt(d.slice(3,5).join(""),2);const u=Number.parseInt(d.slice(5,8).join(""),2);for(a.colorTableSize=2**(u+1),a.localColorTable&&(a.colorTable=t.readColorTable(a.colorTableSize)),a.lzwMinCodeSize=t.readByte(),a.dataPositions=[];;){const g=t.readByte();if(g===0)break;const w=t.offset;a.dataPositions.push([w,g]),t.offset=w+g}e.frames.push(a),a=r(),a.index=e.frames.length;continue}if(c===33){const d=t.readByte();if(f.push(d),d===255){if(t.readByte()!==11)continue;const u={identifier:t.readString(8),code:t.readString(3),data:[]};`${u.identifier}${u.code}`=="NETSCAPE2.0"&&t.readByte()===3&&(e.looped=!!t.readByte(),e.loopCount=t.readUnsigned()),u.data=t.readSubBlock(),a.application=u;continue}if(d===254){a.comment=t.readSubBlock().map(u=>String.fromCharCode(u)).join("");continue}if(d===249){if(t.readByte()!==4)continue;const u=t.readBits(),g={reserved:Number.parseInt(u.slice(0,3).join(""),2),disposal:Number.parseInt(u.slice(3,6).join(""),2),userInput:!!u[6],transparent:!!u[7],delayTime:t.readUnsigned(),transparentIndex:t.readByte()};t.readSubBlock(),a.graphicControl=g,a.disposal=g.disposal,a.delay=(g.delayTime||10)*10;continue}if(d===1){if(t.readByte()!==1)continue;a.plainText={left:t.readUnsigned(),top:t.readUnsigned(),width:t.readUnsigned(),height:t.readUnsigned(),cellWidth:t.readByte(),cellHeight:t.readByte(),colorIndex:t.readByte(),backgroundColorIndex:t.readByte(),data:t.readSubBlock()};continue}console.warn(`Unknown extension block: 0x${d.toString(16)}`,l.slice(0,l.length-1).map(u=>`0x${u.toString(16)}`),f.slice(0,f.length-1).map(u=>`0x${u.toString(16)}`));continue}if(c===59)break;console.warn(`Unknown block: 0x${c.toString(16)}`,l.slice(0,l.length-1).map(d=>`0x${d.toString(16)}`),f.slice(0,f.length-1).map(d=>`0x${d.toString(16)}`))}return e}function oe(h){const e=new Map,{workerUrl:t}=h;let{workerNumber:r=1}=h;const s=[...Array.from({length:t?r:0})].map(()=>{try{const a=new Worker(t);return a.onmessage=i,a}catch(a){return console.warn(a),null}}).filter(Boolean);r=s.length;function i(a){var c;const{id:l,data:f}=a.data;(c=e.get(l))==null||c(f),e.delete(l)}const n=function(){let a=0;return l=>s[(l??a++)%r]}();return{call:function(){let a=0;return(l,f,c,d)=>new Promise(u=>{const g=n(d);if(!g)return u(void 0);e.set(a,u),g.postMessage({id:a++,type:l,data:f},{transfer:c})})}()}}function se(h,e){const t=Array.from({length:h.length}),r=h.length/e,s=[0,4,2,1],i=[8,8,4,2];let n=0;for(let o=0;o<4;o++)for(let a=s[o];a<r;a+=i[o])t.splice.apply(t,[a*e,e].concat(h.slice(n*e,(n+1)*e))),n++;return t}function ae(h,e,t){const i=t;let n,o,a,l,f,c,d;const u=Array.from({length:t}),g=Array.from({length:4096}),w=Array.from({length:4096}),m=Array.from({length:4097}),I=h,p=1<<I,b=p+1;for(n=p+2,f=-1,a=I+1,o=(1<<a)-1,c=0;c<p;c++)g[c]=0,w[c]=c;let y,S,B,T,A,O;for(y=S=B=T=A=O=0,d=0;d<i;){if(T===0){if(S<a){y+=e[O]<<S,S+=8,O++;continue}if(c=y&o,y>>=a,S-=a,c>n||c===b)break;if(c===p){a=I+1,o=(1<<a)-1,n=p+2,f=-1;continue}if(f===-1){m[T++]=w[c],f=c,B=c;continue}for(l=c,c===n&&(m[T++]=B,c=f);c>p;)m[T++]=w[c],c=g[c];B=w[c]&255,m[T++]=B,n<4096&&(g[n]=f,w[n]=B,n++,!(n&o)&&n<4096&&(a++,o+=n)),f=l}T--,u[A++]=m[T],d++}for(d=A;d<i;d++)u[d]=0;return u}function le(h,e){const t=F(h,"uint8Array");if(e!=null&&e.workerUrl)return oe({workerUrl:e.workerUrl}).call("frames:decode",t,[t.buffer]);const{gif:r=ie(h),range:s}=e??{},{width:i,height:n,colorTable:o,frames:a}=r,l=s?a.slice(s[0],s[1]+1):a,f=l.some(g=>g.disposal===3);let c=new Uint8ClampedArray(i*n*4),d,u=c.slice();return l.map(g=>{const{left:w,top:m,width:I,height:p,interlaced:b,localColorTable:y,colorTable:S,lzwMinCodeSize:B,dataPositions:T,graphicControl:A,delay:O,disposal:W}=g,G=d==null?void 0:d.disposal,Y=m+p,{transparent:M,transparentIndex:Ue}=A??{},ee=y?S:o,ve=M?Ue:-1,Pe=K(T.map(([N,L])=>t.subarray(N,N+L)));let te=ae(B,Pe,I*p);if(b&&(te=se(te,I)),G===3)c=u.slice();else if(G===2){const{left:N,top:L,width:re,height:X}=d,H=L+X;for(let U=L;U<H;U++){const ne=U*i+N;for(let D=0;D<re;D++){const $=(ne+D)*4;c[$]=c[$+1]=c[$+2]=c[$+3]=0}}}for(let N=m;N<Y;N++){const L=N*i+w,re=(N-m)*I;for(let X=0;X<I;X++){const H=te[re+X],U=(L+X)*4;if(H!==ve){const[ne,D,$]=(ee==null?void 0:ee[H])??[0,0,0];c[U]=ne,c[U+1]=D,c[U+2]=$,c[U+3]=255}}}return f&&W!==1&&W!==3&&(u=c.slice()),d=g,{width:i,height:n,delay:O,data:c.slice()}})}function me(h,e,t){return le(h,{gif:t,range:[0,Math.max(e,0)]}).pop()}function _e(h,e,t){const r=F(h,"uint8Array"),{frames:s,colorTable:i}=e,n=s[t];if(!n)throw new Error(`This index ${t} does not exist in frames`);const{width:o,height:a,delay:l,interlaced:f,localColorTable:c,colorTable:d,lzwMinCodeSize:u,dataPositions:g,graphicControl:w}=n,{transparent:m,transparentIndex:I}=w??{},p=c?d:i,b=m?I:-1,y=K(g.map(([T,A])=>r.subarray(T,T+A)));let S=ae(u,y,o*a);f&&(S=se(S,o));const B=new Uint8ClampedArray(o*a*4);for(let T=S.length,A=0;A<T;A++){const O=S[A];if(O===b)continue;const[W,G,Y]=(p==null?void 0:p[O])??[0,0,0],M=A*4;B[M]=W,B[M+1]=G,B[M+2]=Y,B[M+3]=255}return{width:o,height:a,delay:l,data:B}}const xe=typeof window<"u",_=65535,v=_*_,ye=511,Z=[0,20,40,60,80,99,119,139,159,179,199,219,241,264,288,313,340,367,396,427,458,491,526,562,599,637,677,718,761,805,851,898,947,997,1048,1101,1156,1212,1270,1330,1391,1453,1517,1583,1651,1720,1790,1863,1937,2013,2090,2170,2250,2333,2418,2504,2592,2681,2773,2866,2961,3058,3157,3258,3360,3464,3570,3678,3788,3900,4014,4129,4247,4366,4488,4611,4736,4864,4993,5124,5257,5392,5530,5669,5810,5953,6099,6246,6395,6547,6700,6856,7014,7174,7335,7500,7666,7834,8004,8177,8352,8528,8708,8889,9072,9258,9445,9635,9828,10022,10219,10417,10619,10822,11028,11235,11446,11658,11873,12090,12309,12530,12754,12980,13209,13440,13673,13909,14146,14387,14629,14874,15122,15371,15623,15878,16135,16394,16656,16920,17187,17456,17727,18001,18277,18556,18837,19121,19407,19696,19987,20281,20577,20876,21177,21481,21787,22096,22407,22721,23038,23357,23678,24002,24329,24658,24990,25325,25662,26001,26344,26688,27036,27386,27739,28094,28452,28813,29176,29542,29911,30282,30656,31033,31412,31794,32179,32567,32957,33350,33745,34143,34544,34948,35355,35764,36176,36591,37008,37429,37852,38278,38706,39138,39572,40009,40449,40891,41337,41785,42236,42690,43147,43606,44069,44534,45002,45473,45947,46423,46903,47385,47871,48359,48850,49344,49841,50341,50844,51349,51858,52369,52884,53401,53921,54445,54971,55500,56032,56567,57105,57646,58190,58737,59287,59840,60396,60955,61517,62082,62650,63221,63795,64372,64952,65535],ce=[0,6,13,18,22,25,28,31,34,36,38,40,42,44,46,48,50,51,53,54,56,57,59,60,61,62,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,86,87,88,89,90,91,91,92,93,94,95,95,96,97,98,98,99,100,101,101,102,103,103,104,105,106,106,107,108,108,109,110,110,111,111,112,113,113,114,115,115,116,116,117,118,118,119,119,120,121,121,122,122,123,123,124,125,125,126,126,127,127,128,128,129,129,130,130,131,132,132,133,133,134,134,135,135,136,136,137,137,138,138,139,139,140,140,140,141,141,142,142,143,143,144,144,145,145,146,146,147,147,147,148,148,149,149,150,150,151,151,151,152,152,153,153,154,154,154,155,155,156,156,156,157,157,158,158,159,159,159,160,160,161,161,161,162,162,163,163,163,164,164,165,165,165,166,166,166,167,167,168,168,168,169,169,169,170,170,171,171,171,172,172,172,173,173,174,174,174,175,175,175,176,176,176,177,177,177,178,178,179,179,179,180,180,180,181,181,181,182,182,182,183,183,183,184,184,184,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,191,191,191,192,192,192,193,193,193,193,194,194,194,195,195,195,196,196,196,197,197,197,198,198,198,198,199,199,199,200,200,200,201,201,201,201,202,202,202,203,203,203,204,204,204,204,205,205,205,206,206,206,206,207,207,207,208,208,208,208,209,209,209,210,210,210,210,211,211,211,212,212,212,212,213,213,213,214,214,214,214,215,215,215,215,216,216,216,217,217,217,217,218,218,218,218,219,219,219,220,220,220,220,221,221,221,221,222,222,222,222,223,223,223,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,227,228,228,228,228,229,229,229,229,230,230,230,230,231,231,231,231,232,232,232,232,233,233,233,233,234,234,234,234,235,235,235,235,236,236,236,236,237,237,237,237,238,238,238,238,239,239,239,239,239,240,240,240,240,241,241,241,241,242,242,242,242,243,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,249,250,250,250,250,251,251,251,251,251,252,252,252,252,253,253,253,253,253,254,254,254,254,255,255,255];function V(h){let e;if(h<=0)return 0;if(h>=_)return _;e=h*(h*(h+-144107)/_+132114)/_+14379;for(let t=0;t<2;t++){const r=e*e*e,s=h+(2*r+v/2)/v;e=(e*(2*h+(r+v/2)/v)+s/2)/s}return e}function k(h,e){return(h^e)<0?(h-e/2)/e:(h+e/2)/e}function he(h,e,t,r,s=!0,i=[255,255,255]){if(!s){r/=255;const n=1-r;h=h*r+n*i[0]&255,e=e*r+n*i[1]&255,t=t*r+n*i[2]&255}return{r:h,g:e,b:t}}function q(h,e,t){return h<<16|e<<8|t}function de(h,e,t){h=Z[h],e=Z[e],t=Z[t];const r=(27015*h+35149*e+3372*t+_/2)/_,s=(13887*h+44610*e+7038*t+_/2)/_,i=(5787*h+18462*e+41286*t+_/2)/_,n=V(r),o=V(s),a=V(i);return{l:k(13792*n+52010*o-267*a,_),a:k(129628*n-159158*o+29530*a,_),b:k(1698*n+51299*o-52997*a,_)}}function j(h){if(h<=0)return 0;if(h>=_)return 255;{const e=h*ye,t=~~(e/_),r=e%_,s=ce[t],i=ce[t+1];return(r*(i-s)+_/2)/_+s}}function Ie(h){const e=h.l+k(25974*h.a,_)+k(14143*h.b,_),t=h.l+k(-6918*h.a,_)+k(-4185*h.b,_),r=h.l+k(-5864*h.a,_)+k(-84638*h.b,_),s=e**3/v,i=t**3/v,n=r**3/v,o=~~j((267169*s+-216771*i+15137*n+_/2)/_),a=~~j((-83127*s+171030*i+-22368*n+_/2)/_),l=~~j((-275*s+-46099*i+111909*n+_/2)/_);return{r:o,g:a,b:l}}function Ce(h){return new Promise(e=>{const t=new Image;t.decoding="sync",t.loading="eager",t.crossOrigin="anonymous",t.onload=()=>e(t),t.onerror=()=>e(t),t.src=h})}class z{constructor(){this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:async e=>{let t;switch(typeof e){case"string":{const r=await Ce(e),s=z.ctx2d,i=s.canvas;s.clearRect(0,0,i.width,i.height),i.width=r.width,i.height=r.height,s.drawImage(r,0,0,i.width,i.height),t=s.getImageData(0,0,i.width,i.height).data;break}default:if(ArrayBuffer.isView(e))t=new Uint8ClampedArray(e.buffer);else if(e instanceof ArrayBuffer)t=new Uint8ClampedArray(e);else if(Array.isArray(e))if(Array.isArray(e[0])){const r=[];for(let s=e.length,i=0;i<s;i++)r.push(e[i][0]??0,e[i][1]??0,e[i][2]??0,e[i][3]??255);t=new Uint8ClampedArray(r)}else t=new Uint8ClampedArray(e);else{const r=z.ctx2d,s=r.canvas;r.clearRect(0,0,s.width,s.height),s.width=typeof e.width=="number"?e.width:e.width.baseVal.value,s.height=typeof e.height=="number"?e.height:e.height.baseVal.value,r.drawImage(e,0,0,s.width,s.height),t=r.getImageData(0,0,s.width,s.height).data}break}this._rsControler.enqueue(t)},close:()=>{this._rsControler.close()}})}static get ctx2d(){if(!this._ctx2d){if(!xe)throw new Error("Failed to get ImageToPixels.ctx2d, not in browser.");const e=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});if(!e)throw new Error("Failed to get ImageToPixels.ctx2d, getContext('2d') return null.");this._ctx2d=e}return this._ctx2d}}class Q{constructor(e){this.maxColors=e,this.readable=new ReadableStream({start:t=>this._rsControler=t}),this.writable=new WritableStream({write:t=>{this._rsControler.enqueue(this._boxesToQuantizedColors(this._colorsToBoxes(t)))},close:()=>{this._rsControler.close()}})}static createSorter(e){const t=e[0],r=e[1],s=e[2];return(i,n)=>i.lab[t]-n.lab[t]||i.lab[r]-n.lab[r]||i.lab[s]-n.lab[s]}_colorsToBoxes(e){let t={start:0,end:e.length-1,sorted:null,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};const r=[t];let s=1;const i=(l,f,c)=>l>=f?f>=c?"lab":l>=c?"lba":"bla":l>=c?"alb":f>=c?"abl":"bal",n=l=>{const{start:f,end:c}=l;l.count=c-f+1,l.weight=0;const d={l:0,a:0,b:0};for(let g=f;g<=c;g++){const w=e[g];d.l+=w.lab.l*w.count,d.a+=w.lab.a*w.count,d.b+=w.lab.b*w.count,l.weight+=w.count}l.avg.l=d.l/l.weight,l.avg.a=d.a/l.weight,l.avg.b=d.b/l.weight;const u={l:0,a:0,b:0};for(let g=f;g<=c;g++){const w=e[g];u.l+=(w.lab.l-l.avg.l)**2*w.count,u.a+=(w.lab.a-l.avg.a)**2*w.count,u.b+=(w.lab.b-l.avg.b)**2*w.count}l.sort=i(u.l,u.a,u.b),l.score=Math.max(u.l,u.a,u.b)},o=(l,f)=>{const c={start:f+1,end:l.end,sorted:l.sorted,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};n(c),l.end-=c.count,n(l),r.push(c),s++},a=()=>{let l=-1,f=-1;if(s===this.maxColors)return-1;for(let c=0;c<s;c++){const d=r[c];d.count>=2&&d.score>f&&(l=c,f=d.score)}return l};for(n(t);t&&t.count>1;){const{start:l,end:f,sort:c,sorted:d}=t;if(c!==d){const I=e.slice(l,f+1).sort(Q.createSorter(c));for(let p=I.length,b=0;b<p;b++)e[l+b]=I[b];t.sorted=c}const u=t.weight+1>>1;let g=l,w=0;for(;g<f-1&&(w+=e[g].count,!(w>u));g++);o(t,g);const m=a();t=m>=0?r[m]:null}return r}_boxesToQuantizedColors(e){const t=e.reduce((r,s)=>r+s.weight,0);return e.map(r=>{const{r:s,g:i,b:n}=Ie(r.avg);return{rgbInt:q(s,i,n),rgb:{r:s,g:i,b:n},hex:`#${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`,lab:r.avg,count:r.weight,percentage:r.weight/t}}).sort((r,s)=>r.rgbInt-s.rgbInt)}}class Se{constructor(e,t,r){this.statsMode=e,this.premultipliedAlpha=t,this.tint=r,this._colors=[],this._cache=new Map,this.readable=new ReadableStream({start:s=>this._rsControler=s}),this.writable=new WritableStream({write:s=>{for(let i=s.length,n=0;n<i;n+=4){let o=s[n],a=s[n+1],l=s[n+2];const f=s[n+3];if(this.statsMode==="diff"&&this._previousPixels&&o===this._previousPixels[n]&&a===this._previousPixels[n+1]&&l===this._previousPixels[n+2]&&f===this._previousPixels[n+3])continue;({r:o,g:a,b:l}=he(o,a,l,f,this.premultipliedAlpha,this.tint));const c=q(o,a,l),d={rgbInt:c,lab:de(o,a,l),count:1},u=c%32768;let g=this._cache.get(u);g||this._cache.set(u,g=new Map);let w=g.get(c);if(w!==void 0){this._colors[w].count++;continue}w=this._colors.push(d)-1,g.set(c,w)}this.statsMode==="diff"&&(this._previousPixels=s)},close:()=>{this._rsControler.enqueue(this._colors.slice()),this._rsControler.close(),this._colors.length=0,this._cache.clear(),this._previousPixels=void 0}})}}class fe{constructor(e=[],t=!1,r=[255,255,255]){this._premultipliedAlpha=t,this._tint=r,this._cache=new Map,this._colorMap=[],e.length&&this.setup(e)}setup(e){e=e.sort((n,o)=>n.rgbInt-o.rgbInt),this._cache.clear();const t=[],r=new Map;for(let n=-1,o=e.length,a=0;a<o;a++){const{rgbInt:l}=e[a];if(l===n){r.set(a,!0);continue}n=l}i({min:[-65535,-65535,-65535],max:[65535,65535,65535]}),this._colorMap=t;function s(n){const o={min:[65535,65535,65535],max:[-65535,-65535,-65535]},a=[];for(let g=e.length,w=0;w<g;w++){const{lab:m}=e[w];r.has(w)||m.l<n.min[0]||m.a<n.min[1]||m.b<n.min[2]||m.l>n.max[0]||m.a>n.max[1]||m.b>n.max[2]||(m.l<o.min[0]&&(o.min[0]=m.l),m.a<o.min[1]&&(o.min[1]=m.a),m.b<o.min[2]&&(o.min[2]=m.b),m.l>o.max[0]&&(o.max[0]=m.l),m.a>o.max[1]&&(o.max[1]=m.a),m.b>o.max[2]&&(o.max[2]=m.b),a.push({lab:m,index:w}))}let l="l",f=0;if(!a.length)return{index:-1,longest:l,longestIndex:f};const c=o.max[0]-o.min[0],d=o.max[1]-o.min[1],u=o.max[2]-o.min[2];return u>=c&&u>=d&&(l="b",f=2),d>=c&&d>=u&&(l="a",f=1),c>=d&&c>=u&&(l="l",f=0),{index:a.sort((g,w)=>g.lab[l]-w.lab[l])[a.length>>1].index,longest:l,longestIndex:f}}function i(n){const{index:o,longest:a,longestIndex:l}=s(n);if(o<0)return-1;r.set(o,!0);const{lab:f}=e[o],c={left:0,right:0,longest:a,lab:f,index:o},d=t.push(c)-1,u={max:[...n.max],min:[...n.min]},g={max:[...n.max],min:[...n.min]};u.max[l]=f[a],g.min[l]=Math.min(f[a]+1,65535);const w=i(u);let m=-1;return g.min[l]<=g.max[l]&&(m=i(g)),c.left=w,c.right=m,d}}_colormapNearestNode(e,t,r){const{left:s,right:i,longest:n,lab:o,index:a}=this._colorMap[e],l=Math.min((t.l-o.l)**2+(t.a-o.a)**2+(t.b-o.b)**2,4294967294);l<r.dist&&(r.index=a,r.dist=l);let f,c;if(s!==-1||i!==-1){const d=t[n]-o[n];d<=0?(f=s,c=i):(f=i,c=s),f!==-1&&this._colormapNearestNode(f,t,r),c!==-1&&d**2<r.dist&&this._colormapNearestNode(c,t,r)}}findNearestIndex(e,t,r,s=255){({r:e,g:t,b:r}=he(e,t,r,s,this._premultipliedAlpha,this._tint));const i=q(e,t,r),n=i%32768;let o=this._cache.get(n);o||this._cache.set(n,o=new Map);let a=o.get(i);if(a!==void 0)return a;const l={dist:Number.MAX_SAFE_INTEGER,index:-1};return this._colormapNearestNode(0,de(e,t,r),l),a=l.index,o.set(i,a),a}}class Te{constructor(e={}){this.colors=[],this.config=this._resolveOptions(e),this._stream=this._createStream()}_resolveOptions(e){const{maxColors:t=256,statsMode:r="full",algorithm:s="median-cut",premultipliedAlpha:i=!1,tint:n=[255,255,255],samples:o=[]}=e;return{maxColors:t,statsMode:r,algorithm:s,premultipliedAlpha:i,tint:n,samples:o}}_createStream(){let e;switch(this.config.algorithm){case"median-cut":default:e=new Q(this.config.maxColors);break}return new ReadableStream({start:t=>{this._streamControler=t,this.config.samples.forEach(r=>t.enqueue(r))}}).pipeThrough(new z).pipeThrough(new Se(this.config.statsMode,this.config.premultipliedAlpha,this.config.tint)).pipeThrough(e)}addSample(e){this._streamControler.enqueue(e)}generate(){return new Promise(e=>{this._streamControler.close(),this._stream.pipeTo(new WritableStream({write:t=>{this.colors=t,this.finder=new fe(t,this.config.premultipliedAlpha,this.config.tint),this._stream=this._createStream(),e(t)}}))})}match(e){var t;let r;if(typeof e=="number")r=[e>>24&255,e>>16&255,e>>8&255,e&255];else if(typeof e=="string"){const n=e.replace(/^#/,"");r=[`${n[0]}${n[1]}`,`${n[2]}${n[3]}`,`${n[4]}${n[5]}`].map(o=>parseInt(o,16))}else if(Array.isArray(e))r=e;else throw new TypeError("Unsupported color format");const s=(t=this.finder)==null?void 0:t.findNearestIndex(r[0],r[1],r[2],r[3]);if(s===void 0||s<0)return;const i=this.colors[s];if(i)return{color:i,index:s}}toColors(){return this.colors.slice()}toHexColors(){return this.colors.map(e=>e.hex)}toRgbColors(){return this.colors.map(e=>e.rgb)}toRgbIntColors(){return this.colors.map(e=>e.rgbInt)}toLabColors(){return this.colors.map(e=>e.lab)}toUint8Array(e=this.colors.length*4){var t;let r;const s=new Uint8ClampedArray(e);for(let i=0;i<e;i++){const n=i*4,o=((t=this.colors[i])==null?void 0:t.rgb)??r;o&&(s[n]=o.r,s[n+1]=o.g,s[n+2]=o.b,s[n+3]=255,r=o)}return s}clear(){this.colors.length=0,this._stream=this._createStream()}}const P=class P{constructor(e=!0){this.isDebug=e}time(e){this.isDebug&&console.time(`${P.prefix} ${e}`)}timeEnd(e){this.isDebug&&console.timeEnd(`${P.prefix} ${e}`)}debug(...e){this.isDebug&&console.debug(P.prefix,...e)}warn(...e){this.isDebug&&console.warn(P.prefix,...e)}};x(P,"prefix","[modern-gif]");let J=P;class Ee{constructor(e){x(this,"_rsControler");x(this,"_frames",[]);x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{this._frames.push(e)},close:()=>{const e=this._config.backgroundColorIndex;let t;this._frames.forEach((r,s)=>{var I;const{width:i=1,height:n=1,data:o}=r,a=r.transparent||(((I=this._frames[s+1])==null?void 0:I.transparent)??!0);let l=0,f=0,c=i-1,d=n-1,u;if(a){for(;f<d;){let p=!0;for(let b=0;b<i;b++)if(o[i*f+b]!==e){p=!1;break}if(!p)break;f++}for(;d>f;){let p=!0;for(let b=0;b<i;b++)if(o[i*d+b]!==e){p=!1;break}if(!p)break;d--}for(;l<c;){let p=!0;for(let b=f;b<d;b++)if(o[i*b+l]!==e){p=!1;break}if(!p)break;l++}for(;c>l;){let p=!0;for(let b=f;b<d;b++)if(o[i*b+c]!==e){p=!1;break}if(!p)break;c--}}else{if(t){for(;f<d;){let p=!0;for(let b=0;b<i;b++){const y=i*f+b;if(o[y]!==t[y]){p=!1;break}}if(!p)break;f++}for(;d>f;){let p=!0;for(let b=0;b<i;b++){const y=i*d+b;if(o[y]!==t[y]){p=!1;break}}if(!p)break;d--}if(f===d)l=c;else{for(;l<c;){let p=!0;for(let b=f;b<=d;b++){const y=b*i+l;if(o[y]!==t[y]){p=!1;break}}if(!p)break;l++}for(;c>l;){let p=!0;for(let b=f;b<=d;b++){const y=b*i+c;if(o[y]!==t[y]){p=!1;break}}if(!p)break;c--}}}u=t,t=o}const g=c+1-l,w=d+1-f,m=new Uint8ClampedArray(g*w);for(let p=0;p<w;p++)for(let b=0;b<g;b++){const y=p*g+b,S=(f+p)*i+(l+b);if(!a&&u&&o[S]===u[S]){m[y]=e;continue}m[y]=o[S]}this._rsControler.enqueue({...r,left:l,top:f,width:g,height:w,disposal:a?2:1,data:m,graphicControl:{...r.graphicControl,transparent:!0,transparentIndex:e}})}),this._rsControler.close()}}));this._config=e}}class ue{constructor(e=4096){x(this,"_chunks");x(this,"_chunkIndex",0);x(this,"_chunkOffset",0);this._chunkByteLength=e,this._chunks=[this._createChunk()]}get cursor(){return[this._chunkIndex,this._chunkOffset]}_createChunk(){return new DataView(new ArrayBuffer(this._chunkByteLength))}writeByte(e,t){t?this._chunks[t[0]].setUint8(t[1],e):(this._chunkOffset>=this._chunkByteLength&&(this._chunks[++this._chunkIndex]=this._createChunk(),this._chunkOffset=0),this._chunks[this._chunkIndex].setUint8(this._chunkOffset++,e))}writeBytes(e){e.forEach(t=>this.writeByte(t))}writeString(e){e.split("").forEach(t=>{this.writeByte(t.charCodeAt(0))})}writeUnsigned(e){this.writeBytes([e&255,e>>8&255])}calculateDistance(e){return this._chunkIndex*this._chunkByteLength+this._chunkOffset-(e[0]*this._chunkByteLength+e[1])}toUint8Array(){this._chunks[this._chunkIndex]=new DataView(this._chunks[this._chunkIndex].buffer.slice(0,this._chunkOffset));const e=new Uint8Array(this._chunks.reduce((r,s)=>r+s.byteLength,0));let t=0;return this._chunks.forEach(r=>{e.set(new Uint8Array(r.buffer),t),t+=r.byteLength}),this._chunks=[this._createChunk()],this._chunkIndex=0,this._chunkOffset=0,e}}class Be{constructor(e){x(this,"_rsControler");x(this,"_frames",[]);x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{this._frames.push(e)},close:()=>{const e=this._encodeHeader(),t=K(this._frames),r=new Uint8Array(e.length+t.byteLength+1);r.set(e),r.set(t,e.byteLength),r[r.length-1]=59,this._rsControler.enqueue(r),this._rsControler.close(),this._frames.length=0}}));this._config=e}_encodeHeader(){var s,i;const e={version:"89a",looped:!0,loopCount:0,pixelAspectRatio:0,...this._config};if(e.width<=0||e.width>65535)throw new Error("Width invalid.");if(e.height<=0||e.height>65535)throw new Error("Height invalid.");let t=0;if((s=e.colorTable)!=null&&s.length){let n=e.colorTable.length;if(n<2||n>256||n&n-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;n>>=1;)++t;if(n=1<<t,e.colorTableSize=--t,e.backgroundColorIndex>=n)throw new Error("Background index out of range.");if(e.backgroundColorIndex===0)throw new Error("Background index explicitly passed as 0.")}const r=new ue;return r.writeString(E),r.writeString(e.version),r.writeUnsigned(e.width),r.writeUnsigned(e.height),r.writeByte(Number.parseInt(`${e.colorTableSize?1:0}1110${e.colorTableSize.toString(2).padStart(3,"0")}`,2)),r.writeByte(e.backgroundColorIndex),r.writeByte(e.pixelAspectRatio),r.writeBytes(((i=e.colorTable)==null?void 0:i.flat())??[]),e.looped&&(r.writeByte(33),r.writeByte(255),r.writeByte(11),r.writeString("NETSCAPE2.0"),r.writeByte(3),r.writeByte(1),r.writeUnsigned(e.loopCount),r.writeByte(0)),r.toUint8Array()}}function Ae(h,e,t){t.writeByte(h);let r=t.cursor;t.writeByte(0);const s=1<<h,i=s-1,n=s+1;let o=n+1,a=h+1,l=0,f=0;function c(p){for(;l>=p;)t.writeByte(f&255),f>>=8,l-=8,t.calculateDistance(r)===256&&(t.writeByte(255,r),r=t.cursor,t.writeByte(0))}function d(p){f|=p<<l,l+=a,c(8)}let u=e[0]&i,g={},w,m,I;d(s);for(let p=e.length,b=1;b<p;++b)if(I=e[b]&i,w=u<<8|I,m=g[w],m===void 0){for(f|=u<<l,l+=a;l>=8;)t.writeByte(f&255),f>>=8,l-=8,t.calculateDistance(r)===256&&(t.writeByte(255,r),r=t.cursor,t.writeByte(0));o===4096?(d(s),o=n+1,a=h+1,g={}):(o>=1<<a&&++a,g[w]=o++),u=I}else u=m;d(u),d(n),c(1),t.calculateDistance(r)===1?t.writeByte(0,r):(t.writeByte(t.calculateDistance(r)-1,r),t.writeByte(0))}class ke{constructor(e){x(this,"_rsControler");x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{var g,w;const t=new ue,{left:r=0,top:s=0,width:i=0,height:n=0,delay:o=100,colorTable:a}=e;let{disposal:l=0}=e;const f=(g=e.graphicControl)==null?void 0:g.transparent;let c=((w=e.graphicControl)==null?void 0:w.transparentIndex)??255;if(r<0||r>65535)throw new Error("Left invalid.");if(s<0||s>65535)throw new Error("Top invalid.");if(i<=0||i>65535)throw new Error("Width invalid.");if(n<=0||n>65535)throw new Error("Height invalid.");let d=8,u=a?a.length:0;if(u){if(u<2||u>256||u&u-1)throw new Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;u>>=1;)++d}t.writeByte(33),t.writeByte(249),t.writeByte(4),f?l||(l=2):c=0,t.writeByte(Number.parseInt(`000${Number(l&7).toString(2).padStart(3,"0")}0${f?1:0}`,2)),t.writeUnsigned(o/10),t.writeByte(c),t.writeByte(0),t.writeByte(44),t.writeUnsigned(r),t.writeUnsigned(s),t.writeUnsigned(i),t.writeUnsigned(n),a!=null&&a.length?(t.writeByte(Number.parseInt(`10000${(d-1).toString(2).padStart(3,"0")}`,2)),t.writeBytes(a.flat())):t.writeByte(0),Ae(d,e.data,t),this._rsControler.enqueue(t.toUint8Array())},close:()=>this._rsControler.close()}));this._config=e}}class Ne{constructor(e,t){x(this,"_rsControler");x(this,"_finder");x(this,"readable",new ReadableStream({start:e=>this._rsControler=e}));x(this,"writable",new WritableStream({write:e=>{const t=this._config.backgroundColorIndex,r=e.data;let s=!1;const i=new Uint8ClampedArray(r.length/4);for(let n=r.length,o=0;o<n;o+=4)r[o+3]===0?(i[o/4]=t,s=!0):i[o/4]=this._finder.findNearestIndex(r[o],r[o+1],r[o+2],r[o+3]);this._rsControler.enqueue({...e,data:i,transparent:s})},close:()=>{this._rsControler.close()}}));this._config=e,this._finder=new fe(t,e.premultipliedAlpha,e.tint)}}class ge{constructor(e){x(this,"_logger");x(this,"_palette");x(this,"_config");x(this,"_encodingFrames",[]);x(this,"_encodeUUID",0);x(this,"_worker");var t;this._logger=new J(!!e.debug),this._config=this._resolveOptions(e),this._palette=new Te({maxColors:this._config.maxColors,premultipliedAlpha:this._config.premultipliedAlpha,tint:this._config.tint}),this._config.workerUrl?(this._worker=oe({workerUrl:this._config.workerUrl}),this._worker.call("encoder:init",e)):(t=this._config.frames)==null||t.forEach(r=>this.encode(r))}_resolveOptions(e){["width","height"].forEach(o=>{typeof e[o]<"u"&&Math.floor(e[o])!==e[o]&&(console.warn(`${o} cannot be a floating point number`),e[o]=Math.floor(e[o]))});const{colorTableSize:t=256,backgroundColorIndex:r=t-1,maxColors:s=t-1,premultipliedAlpha:i=!1,tint:n=[255,255,255]}=e;return{...e,colorTableSize:t,backgroundColorIndex:r,maxColors:s,premultipliedAlpha:i,tint:n}}async encode(e){if(this._worker){let n;return ArrayBuffer.isView(e.data)?n=[e.data.buffer]:e.data instanceof ArrayBuffer&&(n=[e.data]),this._worker.call("encoder:encode",e,n)}const t=this._encodeUUID;this._encodeUUID++;const{width:r=this._config.width,height:s=this._config.height}=e;let{data:i}=e;try{this._logger.time(`palette:sample-${t}`),i=typeof i=="string"?await be(i):i,i=F(i,"uint8ClampedArray",{width:r,height:s}),this._encodingFrames.push({...e,width:r,height:s,data:i}),this._palette.addSample(i)}finally{this._logger.timeEnd(`palette:sample-${t}`)}}async flush(e){if(this._worker)return this._worker.call("encoder:flush",e);this._logger.time("palette:generate");const t=await this._palette.generate();this._logger.timeEnd("palette:generate");const r=t.map(i=>[i.rgb.r,i.rgb.g,i.rgb.b]);for(;r.length<this._config.colorTableSize;)r.push([0,0,0]);this._logger.debug("palette:maxColors",this._config.maxColors),this._logger.isDebug&&console.debug(t.map(()=>"%c ").join(""),...t.map(i=>`margin: 1px; background: ${i.hex}`)),this._logger.time("encode");const s=await new Promise(i=>{new ReadableStream({start:n=>{this._encodingFrames.forEach(o=>{n.enqueue(o)}),n.close()}}).pipeThrough(new Ne(this._config,t)).pipeThrough(new Ee(this._config)).pipeThrough(new ke(this._config)).pipeThrough(new Be({...this._config,colorTable:r})).pipeTo(new WritableStream({write:n=>i(n)}))});switch(this._logger.timeEnd("encode"),this._encodingFrames=[],this._encodeUUID=0,e){case"blob":return new Blob([s.buffer],{type:"image/gif"});case"arrayBuffer":default:return s.buffer}}}function Oe(h){return new ge(h).flush(h.format)}C.Encoder=ge,C.decode=ie,C.decodeFrame=me,C.decodeFrames=le,C.decodeUndisposedFrame=_e,C.encode=Oe,Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});
